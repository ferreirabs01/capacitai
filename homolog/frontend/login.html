<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="d-flex align-items-center justify-content-center vh-100 bg-light">

  <div class="card p-4 shadow" style="min-width: 300px; max-width: 400px; width: 100%;">
    <h3 class="text-center mb-4">Login</h3>
    <form id="loginForm">
      <div class="mb-3">
        <label for="usuario" class="form-label">Usuário</label>
        <input type="text" class="form-control" id="usuario" placeholder="admin" required>
      </div>
      <div class="mb-3">
        <label for="senha" class="form-label">Senha</label>
        <input type="password" class="form-control" id="senha" placeholder="admin@" required>
      </div>
      <div id="erro" class="text-danger mb-3 text-center d-none">
        Usuário ou senha inválidos.
      </div>
      <div class="d-grid mb-2">
        <button type="submit" class="btn btn-primary">Entrar</button>
      </div>
      <p class="text-center">
        Ainda não tem conta? <a href="#" data-bs-toggle="modal" data-bs-target="#modalCadastro">Cadastre-se</a>
      </p>
    </form>
  </div>

  <!-- Modal de Cadastro -->
 <!-- Modal de Cadastro -->
<div class="modal fade" id="modalCadastro" tabindex="-1" aria-labelledby="modalCadastroLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCadastroLabel">Cadastro de Entidade</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="formCadastro">
          <div class="mb-3">
            <label for="nome" class="form-label">Nome</label>
            <input type="text" class="form-control" id="nome" required>
          </div>
          <div class="mb-3">
            <label for="tipo" class="form-label">Tipo</label>
            <select id="tipo" class="form-select" required>
              <option value="">Selecione</option>
              <option value="PF">Pessoa Física</option>
              <option value="PJ">Pessoa Jurídica</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="razao_social" class="form-label">Razão Social</label>
            <input type="text" class="form-control" id="razao_social">
          </div>
          <div class="mb-3">
            <label for="nrCadastro" class="form-label">Número de Cadastro (CPF/CNPJ)</label>
            <input type="text" class="form-control" id="nrCadastro" required>
          </div>
          <div class="mb-3">
            <label for="emailCadastro" class="form-label">E-mail</label>
            <input type="email" class="form-control" id="emailCadastro" required>
          </div>
          <div class="mb-3">
            <label for="telefone" class="form-label">Telefone</label>
            <input type="text" class="form-control" id="telefone">
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-success">Cadastrar</button>
          </div>

          
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tipo e Usuário -->
<div class="modal fade" id="modalTipoUsuario" tabindex="-1" aria-labelledby="modalTipoUsuarioLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTipoUsuarioLabel">Tipo de Usuário e Acesso</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="formTipoUsuario">
          <input type="hidden" id="id_entidade_cadastrada">

          <div class="mb-3">
            <label for="tipoUsuario" class="form-label">Tipo de Usuário</label>
            <select id="tipoUsuario" class="form-select" required>
              <option value="">Carregando...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="login" class="form-label">Login</label>
            <input type="text" class="form-control" id="login" required>
          </div>
          <div class="mb-3">
            <label for="senha" class="form-label">Senha</label>
            <input type="password" class="form-control" id="senha" required>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-success">Salvar Acesso</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>



  <!-- JS de validação de login -->
  <script>


    //envio de dados do cadastro para o backend

  document.getElementById('formCadastro').addEventListener('submit', async function (e) {
  e.preventDefault();

  const data = {
    nome: document.getElementById('nome').value.trim(),
    tipo: document.getElementById('tipo').value,
    razao_social: document.getElementById('razao_social').value.trim(),
    nrCadastro: document.getElementById('nrCadastro').value.trim(),
    email: document.getElementById('emailCadastro').value.trim(),
    telefone: document.getElementById('telefone').value.trim()
  };

  try {
    const response = await fetch('/api/entidades/cadastrar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok) {
      alert('Cadastro realizado com sucesso!');
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalCadastro'));
      modal.hide();
      document.getElementById('formCadastro').reset();
    } else {
      alert('Erro ao cadastrar: ' + result.message);
    }
  } catch (err) {
    alert('Erro de conexão com o servidor.');
  }

  if (response.ok) {
  const entidadeId = result.id;

  // Armazena e abre o segundo modal
  document.getElementById('id_entidade_cadastrada').value = entidadeId;

  // Carrega tipos de entidade
  const tipos = await fetch('/api/tipos');
  const listaTipos = await tipos.json();

  const select = document.getElementById('tipoUsuario');
  select.innerHTML = '<option value="">Selecione</option>';
  listaTipos.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id_tipo;
    opt.textContent = t.descricao;
    select.appendChild(opt);
  });

  const modalTipo = new bootstrap.Modal(document.getElementById('modalTipoUsuario'));
  modalTipo.show();

  const modalCadastro = bootstrap.Modal.getInstance(document.getElementById('modalCadastro'));
  modalCadastro.hide();
  document.getElementById('formCadastro').reset();
}

});

document.getElementById('formTipoUsuario').addEventListener('submit', async function (e) {
  e.preventDefault();

  const data = {
    id_entidade: document.getElementById('id_entidade_cadastrada').value,
    id_tipo: document.getElementById('tipoUsuario').value,
    login: document.getElementById('login').value.trim(),
    senha: document.getElementById('senha').value.trim()
  };

  try {
    const res = await fetch('/api/entidades/definir-tipo-e-usuario', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if (res.ok) {
      alert('Tipo de usuário e acesso definidos com sucesso!');
      bootstrap.Modal.getInstance(document.getElementById('modalTipoUsuario')).hide();
    } else {
      alert('Erro ao salvar: ' + result.message);
    }
  } catch (err) {
    alert('Erro ao conectar com o servidor.');
  }
});





  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
